---
name: cf-cdn-analyzer
description: Analyzes Cloudflare CDN configuration and groups rules by proxied hostname for CloudFront migration. Use this skill when you need to understand Cloudflare CDN setup before migrating to CloudFront, identify which domains are proxied, detect SaaS configurations, and prepare for implementation planning. This skill reads CloudflareBackup configuration files, detects SaaS (terminates if found), groups all rules by proxied DNS records, identifies configuration gaps and decision points, and generates hostname-based configuration summary with user input template for business context.
---

# Cloudflare CDN Config Analyzer

Analyze Cloudflare CDN configuration and group by proxied hostname for CloudFront migration planning.

YOU MUST follow the Workflow section below step-by-step.

## Path Resolution

Reference files in `references/` directory. User data from path provided by user.

## Scope

**In Scope:** 
- DNS records (identify proxied hostnames)
- SaaS detection (terminate if enabled)
- Cache rules
- Configuration rules
- Origin rules
- Compression rules
- Custom error pages
- Load balancers
- TLS/HTTP settings

**Out of Scope:** 
- Security rules (use cf-waf-converter)
- Transformation rules (use cf-functions-converter)
- Actual CloudFront configuration generation (handled by downstream skills)

## Workflow

### 1. Obtain Cloudflare Configuration

Ask user for configuration directory path.

**If no files yet:** Recommend https://github.com/chenghit/CloudflareBackup

**If summary exists:** Ask user: "Found existing summary. Use it or regenerate?"

### 2. Discover and Read Configuration Files

**CRITICAL: Search entire directory tree, don't assume locations.**

**Step 2.1:** Use glob to find all configuration files:
- `**/DNS.txt`
- `**/SaaS-Fallback-Origin.txt`
- `**/Cache-Rules.txt`
- `**/Configuration-Rules.txt`
- `**/Origin-Rules.txt`
- `**/Compression-Rules.txt`
- `**/Custom-Error-Rules.txt`
- `**/Load-Balancers.txt`
- `**/Min-TLS-Version.txt`
- `**/HTTP2.txt`, `**/HTTP3.txt`
- `**/WebSockets.txt`
- `**/Early-Hints.txt`
- `**/IP-Lists.txt` (account-level)
- `**/List-Items-*.txt` (account-level)

**Step 2.2:** MANDATORY VALIDATION - If NO configuration files found, STOP immediately:

Display this message to user:

```
⚠️ CRITICAL: No CloudflareBackup configuration files found.

This tool requires configuration files generated by CloudflareBackup:
https://github.com/chenghit/CloudflareBackup

Expected files:
- DNS.txt
- Cache-Rules.txt
- Configuration-Rules.txt
- Origin-Rules.txt
- And other CDN configuration files

⚠️ IMPORTANT NOTICE:
If you continue without providing correct configuration files, any conversion 
attempt will rely solely on the underlying LLM's general capabilities, without 
the specialized conversion logic, validation rules, and best practices encoded 
in this tool. Results will be unpredictable and unsupported.

Please provide the correct CloudflareBackup output directory and try again.
```

**Do NOT proceed if no files found. Stop the workflow here.**

**Step 2.3:** If duplicates found, STOP and ask user to remove duplicates.

**Step 2.4:** Read all discovered files.

**Step 2.5:** Missing files = assume no configuration of that type. Continue processing.

### 3. SaaS Detection (CRITICAL - Must be first check)

**CRITICAL:** Read `SaaS-Fallback-Origin.txt` first.

**If the file contains `origin` field with `status: "active"`:**
- **STOP the conversion immediately**
- Display this message:

```
⚠️ SaaS configuration detected.

Cloudflare Custom Hostnames (SaaS) and CloudFront SaaS have fundamentally 
different implementation models. This requires a separate skill or manual 
migration approach.

Conversion terminated.
```

**If no SaaS detected:** Continue to Step 4.

### 4. Parse DNS Records and Identify Proxied Hostnames

Parse `DNS.txt` to identify:
- All DNS records
- Which records are proxied (proxied: true)
- Record types (A, AAAA, CNAME)
- Record values (IP addresses, domain names)

**For each proxied record:**
- Extract hostname (e.g., example.com, www.example.com, api.example.com)
- Note record type and value
- **If value is IP address (A or AAAA record):** Mark as "requires manual intervention" (CloudFront doesn't support IP-based origins)

**Output:** List of proxied hostnames that will become CloudFront Distributions.

### 5. Group Configuration by Hostname

For each proxied hostname, collect all relevant configuration:

**Cache Rules:**
- Rules that match this hostname (via http.host or wildcard)
- Note: Cloudflare smart defaults (70+ static file extensions) are implicit

**Configuration Rules:**
- Rules affecting this hostname

**Origin Rules:**
- Origin selection rules for this hostname

**Compression Rules:**
- Compression settings for this hostname

**Other Settings:**
- Custom error pages
- Load balancer configuration
- TLS/HTTP version settings
- WebSocket support
- Early Hints

### 6. Identify Configuration Gaps and Decision Points

For each hostname, identify:

**1. Implicit Dependencies:**
- Does this hostname rely on Cloudflare smart defaults for static file caching?
- Mark as "UNKNOWN - requires user input"

**2. Business Context Needed:**
- What is the business type of this hostname? (website/api/cdn/mixed)
- Does it serve static files?
- What are the traffic patterns?

**3. Complex Rules:**
- Rules with regex patterns (cannot convert to Cache Behavior)
- Rules requiring CloudFront Functions or Lambda@Edge

**4. Configuration Duplication:**
- Which rules are repeated across multiple hostnames?
- Candidates for shared Policies or Functions

### 7. Generate Hostname-Based Configuration Summary

Output a Markdown file (`cloudflare-cdn-config-summary.md`) with:

**Section 1: Proxied Hostnames**
- List all proxied hostnames
- For each: record type, value, any issues (e.g., IP-based origin)

**Section 2: Configuration by Hostname**
For each hostname:
- Cache rules affecting this hostname
- Configuration rules
- Origin rules
- Other relevant settings
- **Decision points:** What information is missing?

**Section 3: Configuration Gaps**
- Implicit dependencies on Cloudflare defaults
- Rules that cannot be determined from config alone

**Section 4: User Input Template**
Generate a template for user to fill in:
```markdown
## User Decisions Required

### Hostname: example.com
- Business type: [website/api/cdn/mixed]
- Serves static files: [yes/no]
- If yes, which types: [images/css/js/fonts/all]
- Traffic pattern: [high/medium/low]
- Cost acceptance: [accept Lambda@Edge viewer cost: yes/no]

### Hostname: api.example.com
...
```

**Section 5: Next Steps**
- Instructions to fill in the user input template
- What happens next (Planner skill will use this information)

Save as `cloudflare-cdn-config-summary.md`.

Ask user to review and fill in the User Input Template section.

## Output Files

1. **cloudflare-cdn-config-summary.md** - Hostname-based configuration summary with user input template

## Reference

(To be added as we develop reference documents)


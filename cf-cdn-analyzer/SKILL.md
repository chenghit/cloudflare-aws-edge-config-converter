---
name: cf-cdn-analyzer
description: Analyzes Cloudflare CDN configuration and groups rules by proxied hostname for CloudFront migration. Use this skill when you need to understand Cloudflare CDN setup before migrating to CloudFront, identify which domains are proxied, detect SaaS configurations, and prepare for implementation planning. This skill reads CloudflareBackup configuration files, detects SaaS (terminates if found), groups all rules by proxied DNS records, identifies IP-based origins, and generates hostname-based configuration summary. This skill does NOT make implementation decisions - it only parses and organizes Cloudflare configurations.
---

# Cloudflare CDN Config Analyzer

Analyze Cloudflare CDN configuration and group by proxied hostname for CloudFront migration planning.

**CRITICAL: When activated, your FIRST action is:**
1. Read ALL reference documents (Step 0 in Workflow)
2. Then follow Workflow steps sequentially

**DO NOT:**
- Generate analysis reports directly
- Skip reading reference documents
- Deviate from the Workflow

**Language Adaptation**: Generate output files in the same language as the user's conversation. If user speaks Chinese, generate Chinese markdown files. If user speaks English, generate English markdown files.

## Path Resolution

Reference files in `references/` directory. User data from path provided by user.

## Scope

**Key Point:** This skill does NOT make implementation decisions. It only parses and organizes Cloudflare configurations.

**In Scope:** 
- DNS records (identify proxied hostnames)
- SaaS detection (terminate if enabled)
- IP-based origin detection (mark as non-convertible)
- Cache rules
- Origin rules
- Compression rules
- Redirect rules
- URL rewrite rules
- Bulk redirects
- Request/Response header transform rules
- Managed transforms
- Custom error pages

**Out of Scope:** 
- Security rules (use cf-waf-converter)
- Implementation decisions (handled by Planner skill)
- Actual CloudFront configuration generation (handled by downstream skills)

## Workflow

### 0. Read All Reference Documents (CRITICAL - Must be first)

**Before starting any analysis, you MUST read ALL reference documents:**

1. `references/cloudflare-default-cache-behavior.md` - Cloudflare implicit caching behaviors
2. `references/cloudflare-rule-execution-order.md` - Rule execution order (must preserve in output)
3. `references/output-structure.md` - Output file structure and formatting requirements

**After reading all 3 references, proceed to Step 1.**

### 1. Obtain Cloudflare Configuration

Ask user for configuration directory path.

**If no files yet:** Recommend https://github.com/chenghit/CloudflareBackup

**If summary exists:** Ask user: "Found existing summary. Use it or regenerate?"

### 2. Discover and Read Configuration Files

**CRITICAL: Search entire directory tree, don't assume locations.**

**Step 2.1:** Use glob to find all configuration files:

**Zone-level files:**
- `**/DNS.txt` (CRITICAL - must exist)
- `**/SaaS-Fallback-Origin.txt` (CRITICAL - check first)
- `**/Cache-Rules.txt`
- `**/Origin-Rules.txt`
- `**/Compression-Rules.txt`
- `**/Redirect-Rules.txt`
- `**/URL-Rewrite-Rules.txt`
- `**/Request-Header-Transform.txt`
- `**/Response-Header-Transform.txt`
- `**/Custom-Error-Rules.txt`
- `**/Custom-Pages.txt`
- `**/Managed-Transforms.txt`

**Account-level files:**
- `**/Bulk-Redirect-Rules.txt`
- `**/List-Items-redirect-*.txt`

**Step 2.2:** MANDATORY VALIDATION - If NO configuration files found, STOP immediately:

Display this message to user:

```
⚠️ CRITICAL: No CloudflareBackup configuration files found.

This tool requires configuration files generated by CloudflareBackup:
https://github.com/chenghit/CloudflareBackup

Expected files:
- DNS.txt (CRITICAL)
- SaaS-Fallback-Origin.txt (CRITICAL)
- Cache-Rules.txt
- Origin-Rules.txt
- Redirect-Rules.txt
- URL-Rewrite-Rules.txt
- Request-Header-Transform.txt
- Response-Header-Transform.txt
- Custom-Error-Rules.txt
- And other CDN configuration files

⚠️ IMPORTANT NOTICE:
If you continue without providing correct configuration files, any conversion 
attempt will rely solely on the underlying LLM's general capabilities, without 
the specialized conversion logic, validation rules, and best practices encoded 
in this tool. Results will be unpredictable and unsupported.

Please provide the correct CloudflareBackup output directory and try again.
```

**Do NOT proceed if no files found. Stop the workflow here.**

**Step 2.3:** If duplicates found, STOP and ask user to remove duplicates.

**Step 2.4:** Read all discovered files.

**Step 2.5:** Missing files = assume no configuration of that type. Continue processing.

### 3. SaaS Detection (CRITICAL - Must be first check)

**CRITICAL:** Read `SaaS-Fallback-Origin.txt` BEFORE processing any other files.

**Check for SaaS configuration:**
- If the file contains `origin` field with a non-empty value (not null, not empty string)

**If SaaS detected:**
- **STOP the conversion immediately**
- Display this message:

```
⚠️ SaaS configuration detected.

Cloudflare Custom Hostnames (SaaS) and CloudFront SaaS have fundamentally 
different implementation models:

- Cloudflare SaaS: Zone-wide configuration with Custom Hostnames
- CloudFront SaaS: Per-distribution configuration with tenant domains

This requires a separate skill or manual migration approach.

Conversion terminated.
```

**If no SaaS detected:** Continue to Step 4.

### 4. Parse DNS Records and Identify Proxied Hostnames

Parse `DNS.txt` to identify:
- All DNS records
- Which records are proxied (proxied: true)
- Record types (A, AAAA, CNAME)
- Record values (IP addresses, domain names)

**For each proxied record:**
- Extract hostname (e.g., example.com, www.example.com, api.example.com)
- Note record type and value
- **CRITICAL: If value is IP address (A or AAAA record):**
  - Mark as "⚠️ Non-convertible - IP-based origin"
  - Reason: CloudFront doesn't support IP addresses as origins
  - Manual action required: Use ALB/NLB as origin, or use domain name
  - Continue processing other records

**Output:** List of proxied hostnames that will become CloudFront Distributions.

### 5. Group Configuration by Hostname

**CRITICAL: Only assign rules to specific DNS records if the rule explicitly matches that hostname. If a rule has no hostname match or uses wildcard for all subdomains, it MUST be listed as Global Rule.**

**CRITICAL: Rule Classification Algorithm**

For EVERY rule, follow this decision tree:

```
Step 1: Does the rule expression contain hostname reference?
├─ NO (e.g., "true", "http.request.uri.path eq '/test'")
│  └─ → GLOBAL RULE (stop here)
│
└─ YES (contains http.host or hostname in http.request.full_uri)
   │
   Step 2: Does it use wildcard matching ALL subdomains?
   ├─ YES (e.g., "*.example.com", ".*\\.example\\.com")
   │  └─ → GLOBAL RULE (stop here)
   │
   └─ NO (specific hostname like "cdn.example.com")
      │
      Step 3: Is this hostname in proxied DNS records?
      ├─ YES
      │  └─ → SPECIFIC RULE (list under that DNS record)
      │
      └─ NO
         └─ → ORPHANED RULE (list under Orphaned Rules section)
```

**Examples:**

| Expression | Classification | Reason |
|------------|---------------|--------|
| `true` | Global Rule | No hostname reference |
| `http.request.uri.path eq "/test"` | Global Rule | No hostname reference |
| `http.user_agent contains "bot"` | Global Rule | No hostname reference |
| `http.host wildcard "*.example.com"` | Global Rule | Wildcard for all subdomains |
| `http.request.full_uri wildcard r"https://*.example.com/path/*"` | Global Rule | Wildcard for all subdomains |
| `http.host eq "cdn.example.com"` | Specific Rule (if cdn.example.com is proxied) | Exact hostname match |
| `http.host eq "old.example.com"` | Orphaned Rule (if old.example.com is NOT proxied) | Hostname not in DNS records |
| `cdn.example.com/path` (Bulk Redirect) | Specific Rule (if cdn.example.com is proxied) | Exact hostname match |

**CRITICAL: Wildcard Detection Patterns**

A rule uses wildcard for all subdomains if it contains ANY of these patterns:

1. `*.example.com` (literal asterisk-dot)
2. `.*\.example\.com` (regex dot-asterisk-backslash-dot)
3. `.*\\.example\\.com` (escaped regex)

**Test each rule against these patterns. If ANY match → Global Rule.**

---

**For each proxied hostname, collect relevant configuration using the classification algorithm above.**

**Special cases:**

**Bulk Redirects:**
- Extract hostname from source URL (format: `hostname/path`)
- If `include_subdomains: true` AND source is apex domain → Global Rule
- Include referenced list items from `List-Items-redirect-*.txt`

**Managed Transforms:**
- Always Global Rule (zone-level configuration)

**Custom Pages:**
- Always separate section (not under Global Rules or specific DNS records)
- Note: `state: "default"` with `url: null` = using Cloudflare default
- Note: `url` has value = using custom page

### 6. Generate Hostname-Based Configuration Summary

Output a Markdown file (`hostname-based-config-summary.md`) following the structure defined in `references/output-structure.md`.

**Key requirements:**
- Group all rules by proxied hostname
- Preserve rule priority order within each category
- Include proxied hostnames overview table
- Mark IP-based origins as non-convertible
- List global rules (no http.host match) separately

Save as `hostname-based-config-summary.md`.

### 7. Generate Next Steps Guide

Create `README_1_analyzer.md` with:

```markdown
# Step 1: After Analysis - Next Steps

## What You Have Now

✅ `hostname-based-config-summary.md` - Complete analysis of your Cloudflare CDN configuration grouped by hostname

## What You Need to Do

### Action 1: Edit the Summary (REQUIRED)

Open `hostname-based-config-summary.md` and edit the "Proxied Hostnames" table:

**For each hostname, decide:**
- **Yes**: This hostname serves static files and relies on Cloudflare's default cache behavior
- **No**: This hostname doesn't serve static files OR uses custom Cache Rules exclusively

**Example:**
```
Before: | example.com | CNAME | origin.example.com | Yes / No |
After:  | example.com | CNAME | origin.example.com | Yes |
```

### Action 2: Review Non-Convertible Items

Check the "Non-Convertible Items" section in the summary:
- **IP-based Origins**: These require manual setup (ALB/NLB or domain names) before proceeding

### Action 3: Run the Planner Skill

Once you've edited the summary and addressed non-convertible items:

```bash
# Switch to Planner subagent
/agent swap cf-cdn-planner

# Provide the edited summary
"Plan CloudFront implementation using hostname-based-config-summary.md"
```

The Planner skill will:
1. Read your edited summary
2. Determine CloudFront implementation methods for each rule
3. Generate implementation plan and user decision template
4. Output: README_2_planner.md for next steps

## Questions?

- **What if I'm not sure about default cache behavior?** Choose "No" for now. You can always add explicit cache rules later.
- **What if I have IP-based origins?** Set up ALB/NLB or use domain names before running the Planner.
- **Can I change my decisions later?** Yes, you can re-edit the summary and re-run the Planner.
```

Save as `README_1_analyzer.md`.

### 8. Prompt User to Review and Edit

Display this message to user:

```
✅ Analysis complete! Files generated:
- hostname-based-config-summary.md (configuration summary)
- README_1_analyzer.md (next steps guide)

⚠️ ACTION REQUIRED:

Please edit the "Proxied Hostnames" table in hostname-based-config-summary.md:
1. Open the file
2. Find the "Proxied Hostnames (CNAME Records Only)" table
3. For each hostname, keep either "Yes" or "No" in the last column
4. Save the file

See README_1_analyzer.md for detailed instructions and next steps.
```

## Output Files

1. **hostname-based-config-summary.md** - Hostname-based configuration summary (pure data extraction, no implementation decisions)

## Reference

- `references/cloudflare-default-cache-behavior.md` - Cloudflare implicit caching behaviors (CRITICAL - must understand for accurate analysis)
- `references/output-structure.md` - Output file structure and formatting requirements
- `references/cloudflare-rule-execution-order.md` - Cloudflare rule execution order (must preserve in output)


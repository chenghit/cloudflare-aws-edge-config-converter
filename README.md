# Cloudflare to AWS Edge Migration Tool | [‰∏≠Êñá](./README_CN.md)

**Automatically convert Cloudflare configurations to AWS edge service configurations through AI conversation**

## Why This Tool

Manually converting hundreds of rules when migrating from Cloudflare to AWS is time-consuming and error-prone. This tool leverages GenAI capabilities to automate batch configuration conversion through conversational interaction, reducing migration time from days to hours.

## Features Overview

This tool contains multiple independent Kiro Powers, each focused on specific configuration conversion:

| Power | Input | Output | Status |
|-------|-------|--------|--------|
| **cloudflare-to-aws-waf-converter** | Cloudflare security rules (WAF, Rate Limiting, IP Access, etc.) | AWS WAF configuration (Terraform) | ‚úÖ Available |
| **cloudflare-to-cloudfront-functions-converter** | Cloudflare transformation rules (Redirect, URL Rewrite, Header Transform, etc.) | CloudFront Functions (JavaScript) | ‚úÖ Available |
| **cloudflare-to-cloudfront-config-converter** | Cloudflare CDN configuration (Cache, Origin, SSL, etc.) | CloudFront Distribution configuration (Terraform) | üöß In Development |

**Important**: Each power should be used in a separate Kiro conversation to avoid mixing multiple conversion tasks.

## Recommended Configuration

### Model Selection

- **Default Configuration**: `claude-sonnet-4.5` (Kiro default)
  - Use case: < 100 rules
  - Sufficient for most migration scenarios

- **Large-Scale Configuration**: `claude-sonnet-4.5-1m`
  - Use case: > 100 rules
  - Supports larger context window
  - Configuration: Use `/model` command in Kiro to switch

### System Requirements

- Kiro IDE (desktop application)
- Sufficient disk space for Cloudflare configuration backups

## Quick Start

```bash
# 1. Install Kiro
# Download from: https://kiro.dev/downloads/

# 2. Backup Cloudflare configuration
# Use the standalone backup tool: https://github.com/chenghit/CloudflareBackup
# Follow that repo's README for installation and usage

# 3. Install powers in Kiro
# Open Kiro ‚Üí Powers panel (üëª‚ö° icon)
# Click "Add power from GitHub" ‚Üí "Import power from GitHub"
# Install WAF converter:
#   Enter: https://github.com/chenghit/cloudflare-aws-edge-config-converter/tree/main/cloudflare-to-aws-waf-converter
# Install CloudFront Functions converter:
#   Enter: https://github.com/chenghit/cloudflare-aws-edge-config-converter/tree/main/cloudflare-to-cloudfront-functions-converter

# 4. Start conversion
# Open a new chat in Kiro
# Type: "Please convert the Cloudflare security rules in /path/to/cloudflare-config to AWS WAF configuration"
```

## Prerequisites

### 1. Install Terraform

The AWS WAF configurations generated by this tool require Terraform 1.8.0 or higher.

```bash
# Check current version
terraform version

# If version is lower than 1.8.0, upgrade via:
# https://developer.hashicorp.com/terraform/install
```

**Important**: AWS Provider 6.x requires Terraform >= 1.8.0. Using a lower Terraform version will result in "Unrecognized remote plugin message" error during `terraform plan`.

### 2. Install Kiro

Follow official documentation:
- Kiro installation: https://kiro.dev/docs/getting-started/installation/

## Installation

### Install from GitHub

1. Open Kiro IDE
2. Click Powers panel (üëª‚ö° icon)
3. Click "Add power from GitHub" ‚Üí "Import power from GitHub"
4. Enter repository URL with subdirectory path:
   - For WAF converter: `https://github.com/chenghit/cloudflare-aws-edge-config-converter/tree/main/cloudflare-to-aws-waf-converter`
   - For CloudFront Functions converter: `https://github.com/chenghit/cloudflare-aws-edge-config-converter/tree/main/cloudflare-to-cloudfront-functions-converter`
5. Click "Install"

### Install from Local Path (for development)

1. Clone this repository
2. Open Kiro IDE
3. Click Powers panel
4. Click "Add power from GitHub" ‚Üí "Import power from a folder"
5. Select power directory:
   - `cloudflare-to-aws-waf-converter/`
   - `cloudflare-to-cloudfront-functions-converter/`

## Usage Guide

### Preparation: Backup Cloudflare Configuration

**Recommended Method** (Secure):

Use the standalone backup tool: **[CloudflareBackup](https://github.com/chenghit/CloudflareBackup)**

Follow that repo's README to complete Cloudflare configuration backup, then reference the backup directory path in Kiro for conversion.

**Why not provide API token in Kiro?**

Tokens remain in conversation history, posing a security risk. Using a standalone backup tool locally is more secure.

**Using Example Configurations** (For Testing):

If you want to test the tool without backing up your own configuration, you can use the example configurations provided:
- Location: `examples/cloudflare-configs/`
- Contains real Cloudflare configuration structure
- Can be used directly for testing conversion functionality

### Power 1: Convert Security Rules to AWS WAF

**Activation**: Power activates automatically when you mention "Cloudflare" and "AWS WAF" or "security rules"

**Example Conversation**:

```
User: Please convert the Cloudflare security rules in ./cloudflare_config to AWS WAF configuration

Kiro: [Reads configuration files, generates rule summary]
      Please confirm if the following rule summary is correct...

User: Confirmed

Kiro: Please provide a Web ACL name for deployment

User: my-web-acl

Kiro: [Generates Terraform configuration files]
```

**Output Files**:

- `versions.tf` - Terraform and AWS Provider version constraints (requires AWS Provider >= 6.4.0)
- `main.tf` - Two Web ACL configurations (website and api-and-file)
- `variables.tf` - Variable definitions
- `terraform.tfvars` - Variable values
- `README_aws-waf-terraform-deployment.md` - Deployment guide

**Complete Example**: [examples/conversation-history/cloudflare-to-aws-waf.txt](examples/conversation-history/cloudflare-to-aws-waf.txt)

### Power 2: Convert Transformation Rules to CloudFront Functions

**Activation**: Power activates automatically when you mention "Cloudflare" and "CloudFront" or "transformation" or "redirect"

**Example Conversation**:

```
User: Please convert the Cloudflare transformation rules in ./cloudflare_config to CloudFront Functions

Kiro: [Reads configuration files, generates rule summary]
      Please confirm if the following rule summary is correct...

User: Confirmed

Kiro: Please provide a CloudFront Function name

User: my-viewer-request-function

Kiro: [Generates JavaScript code and deployment guide]
```

**Output Files**:

- `cloudflare-transformation-rules-summary.md` - Rule summary
- `viewer-request-function.js` - CloudFront Function code
- `viewer-request-function.min.js` - Minified version (if needed)
- `key-value-store.json` - KVS data (if needed)
- `README_function_and_kvs_deployment.md` - Deployment guide

**Complete Example**: [examples/conversation-history/cloudflare-to-cloudfront-functions.txt](examples/conversation-history/cloudflare-to-cloudfront-functions.txt)

### Power 3: Convert CDN Configuration to CloudFront (In Development)

This feature is planned for the next release.

## Best Practices

### ‚úÖ Recommended Practices

1. **Convert One Project at a Time**
   - After completing conversion for one domain, start a new conversation
   - Avoid mixing configurations from multiple projects in the same conversation

2. **Convert Different Rule Types Separately**
   - Convert security rules in one conversation
   - Convert transformation rules in another conversation
   - Don't mix conversions in the same conversation

3. **Use Clear Descriptions**
   - For security rules: Mention "AWS WAF" or "security rules"
   - For transformation rules: Mention "CloudFront Function" or "redirect"
   - Helps Kiro correctly activate the appropriate power

4. **Validate Generated Summaries**
   - Kiro will generate rule summaries for your confirmation
   - Carefully review summaries to ensure correct understanding
   - Correct issues promptly if found

### ‚ùå Practices to Avoid

1. **Don't Convert Multiple Projects in the Same Conversation**
   - Causes context confusion
   - AI may hallucinate and mix configurations from different projects

2. **Don't Mix Different Rule Type Conversions**
   - Example: Converting both WAF and CloudFront Functions in the same conversation
   - Reduces conversion quality

3. **Don't Use Vague Descriptions**
   - Avoid: "Help me convert Cloudflare configuration" (unclear what to convert)
   - Use: "Convert Cloudflare security rules to AWS WAF configuration" (specific and clear)

## Limitations and Caveats

### Content Not Converted

* **Managed Rules**
  - Reason: AWS WAF doesn't support Cloudflare-specific features (e.g., API Abuse Detection)
  - Alternative: Directly add managed rules in AWS WAF (Anti-DDoS, Core Rule Set, Bot Control, etc.)
  - These standardized configurations don't require AI conversion, avoiding hallucinations

* **Page Rules (Deprecated)**
  - Reason: Cloudflare has deprecated Page Rules functionality
  - Recommendation: First migrate to modern rule types in Cloudflare (Redirect Rules, URL Rewrite Rules, etc.), then use this tool for conversion

* **Some Advanced Transformation Rules**
  - Reason: Cloudflare and CloudFront features are not one-to-one
  - Note: Tool will list unconvertible rules and alternatives in generated documentation

### Large-Scale Configuration Considerations

* **Token Consumption**
  - Token consumption increases significantly with > 100 rules
  - May affect conversion quality
  - Recommendation: Use `claude-sonnet-4.5-1m` model, or convert in batches

* **Conversion Time**
  - More rules = longer conversion time
  - Typical: ~5-10 minutes for 50 rules

### Conversion Accuracy

* **Manual Review Required**
  - AI-generated configurations require manual review
  - Especially for complex conditional logic and regular expressions
  - Recommend validation in test environment first

* **Edge Cases**
  - Some complex nested conditions may require manual adjustment
  - Tool will mark areas requiring attention in documentation

## Troubleshooting

### Power Not Activated

**Problem**: Kiro doesn't activate the appropriate power for conversion

**Solution**:
1. Check if conversation includes correct keywords (e.g., "Cloudflare" + "AWS WAF")
2. Clearly specify content type to convert (security rules vs transformation rules)
3. Provide complete path to configuration files

### Conversion Results Don't Meet Expectations

**Problem**: Generated configuration doesn't match expectations

**Solution**:
1. Check if Cloudflare configuration files are complete
2. Confirm if rule summary stage correctly understood the configuration
3. Try converting again in a new conversation
4. Consider converting complex configurations in batches

### Context Confusion

**Problem**: AI mixes different projects or different rule types

**Solution**:
1. Stop current conversation immediately
2. Start a new conversation
3. Convert only one type of rule for one project at a time

## Related Resources

- [Kiro Documentation](https://kiro.dev/docs/)
- [Kiro Powers](https://kiro.dev/powers/)
- [AWS WAF Documentation](https://docs.aws.amazon.com/waf/)
- [CloudFront Functions Documentation](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/cloudfront-functions.html)

## Roadmap

### üöß Powers 3-9: Complete CDN Configuration Migration Solution (Architecture Design Phase)

We are designing a comprehensive CDN configuration migration solution that refactors the current single power into multiple specialized powers:

**Architecture Design Documents:**
- [Power 3-4 Architecture Design (English)](./docs/architecture/power-3-4-design-EN.md)
- [Power 3-4 Êû∂ÊûÑËÆæËÆ° (‰∏≠Êñá)](./docs/architecture/power-3-4-design-CN.md)

**Planned Powers:**

| Power | Responsibility | Output | Status |
|-------|---------------|--------|--------|
| **Power 3** | Config Analyzer - Analyze Cloudflare CDN config, group by domain, determine implementation methods | Analysis report, implementation plan, user decision template | üé® Architecture Design |
| **Power 4** | Task Orchestrator - Generate task assignments and execution guide | Task assignment files, execution guide | üé® Architecture Design |
| **Power 5** | Viewer Request Function Converter | CloudFront Function code (one file per domain) | üìù To Be Designed |
| **Power 6** | Viewer Response Function Converter | CloudFront Function code (one file per domain) | üìù To Be Designed |
| **Power 7** | Origin Request Lambda Converter | Lambda@Edge code | üìù To Be Designed |
| **Power 8** | Origin Response Lambda Converter | Lambda@Edge code | üìù To Be Designed |
| **Power 9** | CloudFront Config Generator | Terraform configuration, deployment guide | üìù To Be Designed |

**Key Improvements:**
- ‚úÖ **Domain-based rule grouping** - Meets CloudFront Function 10KB size limit
- ‚úÖ **Implementation-based task assignment** - Not by Cloudflare rule type
- ‚úÖ **Multi-stage conversion workflow** - Analyze ‚Üí Decide ‚Üí Orchestrate ‚Üí Convert ‚Üí Deploy
- ‚úÖ **Cost-aware design** - Mark high-cost solutions (Viewer Lambda@Edge) as non-convertible
- ‚úÖ **Stateless workflow** - State transfer via Markdown files, supports batch processing

**Impact After Implementation:**

‚ö†Ô∏è **When Powers 3-9 are implemented, the current `cloudflare-to-cloudfront-functions-converter` will be deprecated.**

Reasons:
- Powers 3-9 provide more complete CDN configuration conversion (not just Functions)
- Domain-based grouping better handles Function size limits
- Supports more complex conversion scenarios (Lambda@Edge, Policies, Cache Behaviors)
- Clearer workflow and task assignment

**Timeline:**
- 2026 Q1: Complete architecture design, implement Power 3 prototype
- 2026 Q2: Implement Powers 4-9
- 2026 Q2 End: Deprecate `cloudflare-to-cloudfront-functions-converter`
- 2026 Q3: Research subagent architecture for enhanced context isolation
  - Explore Kiro's subagent capabilities to delegate specialized tasks
  - Design workflow where planner, orchestrator, and converters run as isolated subagents
  - Goal: Prevent context mixing and hallucinations by separating concerns within a single conversation

---

## Feedback and Contributions

For issues or suggestions, please submit an Issue or Pull Request.

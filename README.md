# Cloudflare to AWS Edge Migration Tool | [‰∏≠Êñá](./README_CN.md)

**Automatically convert Cloudflare configurations to AWS edge service configurations through AI conversation**

---

## ‚ö†Ô∏è CRITICAL: Required Input Format

**This tool ONLY works with configuration files generated by [CloudflareBackup](https://github.com/chenghit/CloudflareBackup).**

**‚ùå NOT COMPATIBLE with [cf-terraforming](https://github.com/cloudflare/cf-terraforming) (Cloudflare's official tool)**

If you provide Terraform HCL files (`.tf`) generated by cf-terraforming, this tool's Skills will NOT activate. Any conversion attempt will rely solely on the underlying LLM's general capabilities without the specialized conversion logic, validation rules, and best practices encoded in this tool. Results will be unpredictable and unsupported.

**Why CloudflareBackup is required:**
- **Predictable file structure**: CloudflareBackup creates a standard directory structure with fixed file names (`WAF-Custom-Rules.txt`, `Rate-limits.txt`, `IP-Lists.txt`, etc.)
- **One-command backup**: Backs up all configurations in a single run with consistent organization
- **Skills-optimized**: File locations and naming conventions are designed for this tool's workflow

**Why cf-terraforming is not supported:**
- **No standard output structure**: cf-terraforming outputs to stdout; users must manually redirect to files with arbitrary names
- **Manual per-resource execution**: Requires separate commands for each resource type (rulesets, lists, DNS records, etc.)
- **Unpredictable file organization**: Skills cannot reliably locate configuration files without a standard structure

See [Why Not cf-terraforming?](#why-not-cf-terraforming) for detailed technical explanation.

---

## Why This Tool

Manually converting hundreds of rules when migrating from Cloudflare to AWS is time-consuming and error-prone. This tool leverages GenAI capabilities to automate batch configuration conversion through conversational interaction, reducing migration time from days to hours.

## Features Overview

This tool contains multiple independent Agent Skills, each focused on specific configuration conversion:

| Skill | Input | Output | Status |
|-------|-------|--------|--------|
| **cloudflare-to-aws-waf-converter** | Cloudflare security rules (WAF, Rate Limiting, IP Access, etc.) | AWS WAF configuration (Terraform) | ‚úÖ Available |
| **cloudflare-to-cloudfront-functions-converter** | Cloudflare transformation rules (Redirect, URL Rewrite, Header Transform, etc.) | CloudFront Functions (JavaScript) | ‚úÖ Available |
| **cloudflare-cdn-config-analyzer** | Cloudflare CDN configuration (Cache, Origin, SSL, etc.) | Configuration analysis and implementation plan | üöß In Development |

**Why Subagents?** Each skill runs in a separate Kiro subagent with isolated context. This prevents context pollution when handling complex multi-step conversions, especially for the upcoming CDN migration workflow (Skills 3-11) which requires parallel execution of multiple converter skills. See [Architecture Design](./docs/architecture/) for details.

## Recommended Configuration

### Model Selection

- **Default Configuration**: `claude-sonnet-4.5` (Kiro default)
  - Use case: < 100 rules
  - Sufficient for most migration scenarios

- **Large-Scale Configuration**: `claude-sonnet-4.5-1m`
  - Use case: > 100 rules
  - Supports larger context window
  - Configuration: Use `/model` command in Kiro to switch

### System Requirements

- Kiro CLI (command-line tool)
- Sufficient disk space for Cloudflare configuration backups

## Quick Start

```bash
# 1. Install Kiro CLI
curl -fsSL https://cli.kiro.dev/install | bash

# 2. Backup Cloudflare configuration
# Use the standalone backup tool: https://github.com/chenghit/CloudflareBackup
# Follow that repo's README for installation and usage

# 3. Clone this repository and install skills
git clone https://github.com/chenghit/cloudflare-aws-edge-config-converter.git
cd cloudflare-aws-edge-config-converter
./install.sh

# 4. Start Kiro CLI chat
kiro-cli chat

# 5. Switch to converter subagent and start conversion
# In the chat, use /agent swap command:
/agent swap cf-waf-converter

# Then provide the path to your Cloudflare configuration:
# "Convert security rules in /path/to/cloudflare-config"

# Or for transformation rules:
/agent swap cf-functions-converter
# "Convert transformation rules in /path/to/cloudflare-config"
```

## Prerequisites

### 1. Install Terraform

The AWS WAF configurations generated by this tool require Terraform 1.8.0 or higher.

```bash
# Check current version
terraform version

# If version is lower than 1.8.0, upgrade via:
# https://developer.hashicorp.com/terraform/install
```

**Important**: AWS Provider 6.x requires Terraform >= 1.8.0. Using a lower Terraform version will result in "Unrecognized remote plugin message" error during `terraform plan`.

### 2. Install Kiro

Follow official documentation:
- Kiro installation: https://kiro.dev/docs/getting-started/installation/

## Installation

Run the installation script to install skills and subagent configurations:

```bash
git clone https://github.com/chenghit/cloudflare-aws-edge-config-converter.git
cd cloudflare-aws-edge-config-converter
./install.sh
```

This will:
- Copy skills to `~/.kiro/skills/cloudflare-aws-converter/`
- Copy subagent configurations to `~/.kiro/agents/`

Installed subagents:
- `cf-waf-converter` - Converts Cloudflare security rules to AWS WAF
- `cf-functions-converter` - Converts Cloudflare transformation rules to CloudFront Functions

### Updating Skills

To update to the latest version:

```bash
cd cloudflare-aws-edge-config-converter
git pull
./install.sh
```

The install script will automatically replace old skills with new versions.

## Usage Guide

### Preparation: Backup Cloudflare Configuration

**Recommended Method** (Secure):

Use the standalone backup tool: **[CloudflareBackup](https://github.com/chenghit/CloudflareBackup)**

Follow that repo's README to complete Cloudflare configuration backup, then reference the backup directory path in Kiro for conversion.

**Why not provide API token in Kiro?**

Tokens remain in conversation history, posing a security risk. Using a standalone backup tool locally is more secure.

**Using Example Configurations** (For Testing):

If you want to test the tool without backing up your own configuration, you can use the example configurations provided:
- Location: `examples/cloudflare-configs/`
- Contains real Cloudflare configuration structure
- Can be used directly for testing conversion functionality

### Skill 1: Convert Security Rules to AWS WAF

**How to use**: Switch to `cf-waf-converter` subagent using `/agent swap cf-waf-converter`

**Example Conversation**:

```
User: /agent swap cf-waf-converter

Kiro: [Switches to WAF converter subagent]

User: Convert security rules in /path/to/cloudflare-config

Kiro: [Reads configuration files, generates rule summary]
      Please confirm if the following rule summary is correct...

User: Confirmed

Kiro: Please provide a Web ACL name for deployment

User: my-web-acl

Kiro: [Generates Terraform configuration files]
```

**Output Files**:

- `versions.tf` - Terraform and AWS Provider version constraints (requires AWS Provider >= 6.4.0)
- `main.tf` - Two Web ACL configurations (website and api-and-file)
- `variables.tf` - Variable definitions
- `terraform.tfvars` - Variable values
- `README_aws-waf-terraform-deployment.md` - Deployment guide

**Complete Example**: [examples/conversation-history/cloudflare-to-aws-waf.txt](examples/conversation-history/cloudflare-to-aws-waf.txt)

### Skill 2: Convert Transformation Rules to CloudFront Functions

**How to use**: Switch to `cf-functions-converter` subagent using `/agent swap cf-functions-converter`

**Example Conversation**:

```
User: /agent swap cf-functions-converter

Kiro: [Switches to Functions converter subagent]

User: Convert transformation rules in /path/to/cloudflare-config

Kiro: [Reads configuration files, generates rule summary]
      Please confirm if the following rule summary is correct...

User: Confirmed

Kiro: Please provide a CloudFront Function name

User: my-viewer-request-function

Kiro: [Generates JavaScript code and deployment guide]
```

**Output Files**:

- `cloudflare-transformation-rules-summary.md` - Rule summary
- `viewer-request-function.js` - CloudFront Function code
- `viewer-request-function.min.js` - Minified version (if needed)
- `key-value-store.json` - KVS data (if needed)
- `README_function_and_kvs_deployment.md` - Deployment guide

**Complete Example**: [examples/conversation-history/cloudflare-to-cloudfront-functions.txt](examples/conversation-history/cloudflare-to-cloudfront-functions.txt)

### Skill 3: Convert CDN Configuration to CloudFront (In Development)

**Status**: Architecture design phase (Skills 3-11)

This will be a multi-stage workflow involving:
- Skill 3: Config Analyzer - Parse and group Cloudflare CDN config
- Skill 4: Implementation Planner - Determine CloudFront implementation methods
- Skill 5: Plan Validator - Verify implementation plan correctness
- Skill 6: Task Orchestrator - Generate task assignments
- Skills 7-11: Specialized converters (Functions, Lambda@Edge, Config Generator)

See [Architecture Design](./docs/architecture/skill-3-11-design-EN.md) for complete workflow and design decisions.

## Best Practices

### ‚úÖ Recommended Practices

1. **Use Separate Subagents for Different Tasks**
   - Use `/agent swap cf-waf-converter` for security rules
   - Use `/agent swap cf-functions-converter` for transformation rules
   - Each subagent has isolated context to avoid confusion

2. **Convert One Project at a Time**
   - After completing conversion for one domain, start a new chat session
   - Avoid mixing configurations from multiple projects

3. **Provide Clear File Paths**
   - Always specify the full path to your Cloudflare configuration directory
   - Example: "Convert security rules in /Users/me/cloudflare-backup/example.com/2026-01-12"

4. **Validate Generated Summaries**
   - Kiro will generate rule summaries for your confirmation
   - Carefully review summaries to ensure correct understanding
   - Correct issues promptly if found

### ‚ùå Practices to Avoid

1. **Don't Convert Multiple Projects in the Same Conversation**
   - Causes context confusion
   - AI may hallucinate and mix configurations from different projects

2. **Don't Mix Different Rule Type Conversions**
   - Example: Converting both WAF and CloudFront Functions in the same conversation
   - Use separate subagents for different conversion types

3. **Don't Use Vague Descriptions**
   - Avoid: "Help me convert Cloudflare configuration" (unclear what to convert)
   - Use: "Convert Cloudflare security rules to AWS WAF configuration" (specific and clear)

## Limitations and Caveats

### Content Not Converted

* **Managed Rules**
  - Reason: AWS WAF doesn't support Cloudflare-specific features (e.g., API Abuse Detection)
  - Alternative: Directly add managed rules in AWS WAF (Anti-DDoS, Core Rule Set, Bot Control, etc.)
  - These standardized configurations don't require AI conversion, avoiding hallucinations

* **Page Rules (Deprecated)**
  - Reason: Cloudflare has deprecated Page Rules functionality
  - Recommendation: First migrate to modern rule types in Cloudflare (Redirect Rules, URL Rewrite Rules, etc.), then use this tool for conversion

* **Some Advanced Transformation Rules**
  - Reason: Cloudflare and CloudFront features are not one-to-one
  - Note: Tool will list unconvertible rules and alternatives in generated documentation

### Large-Scale Configuration Considerations

* **Token Consumption**
  - Token consumption increases significantly with > 100 rules
  - May affect conversion quality
  - Recommendation: Use `claude-sonnet-4.5-1m` model, or convert in batches

* **Conversion Time**
  - More rules = longer conversion time
  - Typical: ~5-10 minutes for 50 rules

### Conversion Accuracy

* **Manual Review Required**
  - AI-generated configurations require manual review
  - Especially for complex conditional logic and regular expressions
  - Recommend validation in test environment first

* **Edge Cases**
  - Some complex nested conditions may require manual adjustment
  - Tool will mark areas requiring attention in documentation

## Troubleshooting

### Subagent Not Switching

**Problem**: `/agent swap` command doesn't work or subagent not found

**Solution**:
1. Verify installation: Check if `~/.kiro/agents/cf-waf-converter.json` exists
2. Restart Kiro CLI: Exit and start a new `kiro-cli chat` session
3. List available agents: Use `/agent list` to see installed subagents

### Conversion Results Don't Meet Expectations

**Problem**: Generated configuration doesn't match expectations

**Solution**:
1. Check if Cloudflare configuration files are complete
2. Confirm if rule summary stage correctly understood the configuration
3. Try converting again in a new conversation
4. Consider converting complex configurations in batches

### Context Confusion

**Problem**: AI mixes different projects or different rule types

**Solution**:
1. Stop current conversation immediately
2. Start a new conversation with `/agent swap` to the correct subagent
3. Convert only one type of rule for one project at a time

## Why Not cf-terraforming?

[cf-terraforming](https://github.com/cloudflare/cf-terraforming) is Cloudflare's official tool for exporting configurations to Terraform. While it's excellent for Terraform-based infrastructure management, it's not compatible with this conversion tool due to fundamental differences in output structure.

### Output Structure Comparison

**CloudflareBackup (Supported)**:
```
cloudflare_backup/
‚îú‚îÄ‚îÄ account/
‚îÇ   ‚îî‚îÄ‚îÄ 2026-01-31 10-00-00/
‚îÇ       ‚îú‚îÄ‚îÄ IP-Lists.txt                    # Fixed filename
‚îÇ       ‚îú‚îÄ‚îÄ List-Items-ip-block-list.txt    # Predictable pattern
‚îÇ       ‚îî‚îÄ‚îÄ Bulk-Redirect-Rules.txt         # Fixed filename
‚îî‚îÄ‚îÄ example.com/
    ‚îî‚îÄ‚îÄ 2026-01-31 10-00-00/
        ‚îú‚îÄ‚îÄ WAF-Custom-Rules.txt            # Fixed filename
        ‚îú‚îÄ‚îÄ Rate-limits.txt                 # Fixed filename
        ‚îî‚îÄ‚îÄ Redirect-Rules.txt              # Fixed filename
```

**cf-terraforming (Not Supported)**:
```bash
# User must run separate commands and manually name files:
cf-terraforming generate --resource-type cloudflare_ruleset --zone <ID> > any_name_user_wants.tf
cf-terraforming generate --resource-type cloudflare_list --account <ID> > another_name.tf
cf-terraforming generate --resource-type cloudflare_record --zone <ID> > dns.tf

# Result: Unpredictable structure
user_chosen_directory/
‚îú‚îÄ‚îÄ any_name_user_wants.tf      # User-defined name
‚îú‚îÄ‚îÄ another_name.tf             # User-defined name
‚îî‚îÄ‚îÄ dns.tf                      # User-defined name
```

### Why This Matters

**CloudflareBackup's predictable structure** allows Skills to:
1. **Automatically locate files**: Skills know exactly where to find `WAF-Custom-Rules.txt`
2. **Validate completeness**: Skills can check if expected files exist
3. **Handle relationships**: Skills know `List-Items-ip-<name>.txt` corresponds to lists in `IP-Lists.txt`

**cf-terraforming's flexible output** creates problems:
1. **No file discovery**: Skills cannot guess what users named their files
2. **No standard organization**: Users might organize files in any directory structure
3. **Manual coordination required**: Users would need to tell Skills where each file is located

### Example User Experience

**With CloudflareBackup**:
```
User: "Convert Cloudflare security rules in ./cloudflare_backup/example.com/2026-01-31 10-00-00/"
Skill: [Automatically finds WAF-Custom-Rules.txt, Rate-limits.txt, IP-Lists.txt]
```

**With cf-terraforming** (hypothetical):
```
User: "Convert Cloudflare security rules in ./my_terraform/"
Skill: "I cannot find standard configuration files. Please specify:
        - Where are your WAF rules? (filename?)
        - Where are your rate limits? (filename?)
        - Where are your IP lists? (filename?)
        - Where are your list items? (filename?)"
User: [Must manually specify each file location]
```

### Design Decision

This tool prioritizes **automation and reliability** over flexibility:
- **One backup command** (CloudflareBackup) vs. multiple manual commands (cf-terraforming)
- **Predictable file locations** vs. user-defined organization
- **Zero configuration** vs. manual file mapping

If you use cf-terraforming for your Terraform workflow, you would need to manually reorganize its output to match CloudflareBackup's structure (fixed filenames, standard directory layout), which defeats the purpose of this automation tool.

## Related Resources

- [Kiro Documentation](https://kiro.dev/docs/)
- [Agent Skills Support in Kiro CLI](https://kiro.dev/changelog/cli/1-24/)
- [AWS WAF Documentation](https://docs.aws.amazon.com/waf/)
- [CloudFront Functions Documentation](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/cloudfront-functions.html)

## Roadmap

### üöß Skills 3-11: Complete CDN Configuration Migration Solution (Architecture Design Phase)

We are designing a comprehensive CDN configuration migration solution that refactors the current single skill into multiple specialized skills:

**Architecture Design Documents:**
- [Skill 3-11 Architecture Design (English)](./docs/architecture/skill-3-11-design-EN.md)
- [Skill 3-11 Êû∂ÊûÑËÆæËÆ° (‰∏≠Êñá)](./docs/architecture/skill-3-11-design-CN.md)
- [Architecture Changelog](./docs/architecture/CHANGELOG.md)

**Planned Skills:**

| Skill | Responsibility | Output | Status |
|-------|---------------|--------|--------|
| **Skill 3** | Config Analyzer - Parse Cloudflare CDN config and group by hostname | Hostname-based config summary + user input template | üé® Architecture Design |
| **Skill 4** | Implementation Planner - Determine CloudFront implementation methods | Implementation plan | üé® Architecture Design |
| **Skill 5** | Plan Validator - Verify implementation plan correctness | Validation report (critical: wrong plan = wrong converters) | üé® Architecture Design |
| **Skill 6** | Task Orchestrator - Generate task assignments and execution guide | Task assignment files, execution guide | üé® Architecture Design |
| **Skill 7** | Viewer Request Function Converter | CloudFront Function code (one file per domain) | üìù To Be Designed |
| **Skill 8** | Viewer Response Function Converter | CloudFront Function code (one file per domain) | üìù To Be Designed |
| **Skill 9** | Origin Request Lambda Converter | Lambda@Edge code | üìù To Be Designed |
| **Skill 10** | Origin Response Lambda Converter | Lambda@Edge code | üìù To Be Designed |
| **Skill 11** | CloudFront Config Generator | Terraform configuration, deployment guide | üìù To Be Designed |

**Key Improvements:**
- ‚úÖ **Subagent architecture from day one** - All Skills (3-11) implemented as Kiro subagents with isolated contexts
- ‚úÖ **Separation of concerns** - Analyzer (parse), Planner (decide), Validator (verify), Orchestrator (assign)
- ‚úÖ **User decision before planning** - Business context informs technical implementation decisions
- ‚úÖ **Plan validation** - Catch errors before converters execute (no recovery after conversion)
- ‚úÖ **Domain-based rule grouping** - Meets CloudFront Function 10KB size limit
- ‚úÖ **Implementation-based task assignment** - Not by Cloudflare rule type
- ‚úÖ **Multi-stage conversion workflow** - Analyze ‚Üí Decide ‚Üí Plan ‚Üí Validate ‚Üí Orchestrate ‚Üí Convert ‚Üí Deploy
- ‚úÖ **Cost-aware design** - Mark high-cost solutions (Viewer Lambda@Edge) as non-convertible
- ‚úÖ **Stateless workflow** - State transfer via Markdown files, supports batch processing
- ‚úÖ **Automation scripts** - One-command installation and configuration

**Impact After Implementation:**

‚ö†Ô∏è **When Skills 3-11 are implemented, the current `cloudflare-to-cloudfront-functions-converter` will be deprecated.**

Reasons:
- Skills 3-11 provide more complete CDN configuration conversion (not just Functions)
- Domain-based grouping better handles Function size limits
- Supports more complex conversion scenarios (Lambda@Edge, Policies, Cache Behaviors)
- Clearer workflow and task assignment with validation

**Timeline:**
- 2026 Q1: Complete architecture design, implement Skill 3 (Analyzer) as subagent prototype
- 2026 Q2: Implement Skills 4-11 as subagents with context isolation
  - Provide automation scripts for Kiro Skills installation and subagent configuration
  - Deprecate `cloudflare-to-cloudfront-functions-converter`
- 2026 Q3: Optimize subagent workflow and user experience
  - Performance tuning for parallel subagent execution
  - Enhanced error handling and recovery mechanisms
  - User experience improvements based on feedback

---

## Feedback and Contributions

For issues or suggestions, please submit an Issue or Pull Request.
